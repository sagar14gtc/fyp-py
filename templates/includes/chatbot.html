{% comment %} Chatbot UI and Logic {% endcomment %}
<style>
    #chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050; /* Ensure it's above most elements */
    }

    #chatbot-toggle-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.8rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #chatbot-toggle-button:hover {
        background-color: var(--primary-hover);
        transform: scale(1.1);
    }

    #chatbot-window {
        display: none; /* Hidden by default */
        position: fixed;
        bottom: 90px; /* Above the toggle button */
        right: 20px;
        width: 350px;
        max-width: 90vw;
        height: 450px;
        max-height: 70vh;
        background-color: white;
        border-radius: var(--bs-border-radius-lg);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid var(--border-color);
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #chatbot-window.active {
        display: flex;
        opacity: 1;
        transform: translateY(0);
    }

    #chatbot-header {
        background-color: var(--primary-color);
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chatbot-close-button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        opacity: 0.8;
    }
    #chatbot-close-button:hover {
        opacity: 1;
    }

    #chatbot-messages {
        flex-grow: 1;
        padding: 1rem;
        overflow-y: auto;
        background-color: #f8f9fa; /* Light background for messages */
    }

    .chat-message {
        margin-bottom: 0.75rem;
        padding: 0.5rem 0.8rem;
        border-radius: var(--bs-border-radius);
        max-width: 85%;
        word-wrap: break-word;
    }

    .chat-message.user {
        background-color: var(--primary-color);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0;
    }

    .chat-message.bot {
        background-color: #e9ecef; /* Slightly darker than message area bg */
        color: var(--text-dark);
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
     .chat-message.bot.loading span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: var(--text-medium);
        border-radius: 50%;
        margin: 0 2px;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .chat-message.bot.loading span:nth-child(1) { animation-delay: -0.32s; }
    .chat-message.bot.loading span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }


    #chatbot-input-area {
        display: flex;
        padding: 0.75rem;
        border-top: 1px solid var(--border-color);
        background-color: white;
    }

    #chatbot-input {
        flex-grow: 1;
        border: 1px solid var(--border-color);
        border-radius: var(--bs-border-radius);
        padding: 0.5rem 0.75rem;
        margin-right: 0.5rem;
        font-size: 0.9rem;
    }
    #chatbot-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
    }

    #chatbot-send-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--bs-border-radius);
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s ease;
    }
    #chatbot-send-button:hover {
        background-color: var(--primary-hover);
    }
    #chatbot-send-button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
    }

</style>

<div id="chatbot-container">
    <div id="chatbot-window">
        <div id="chatbot-header">
            <span>Chat Assistant</span>
            <button id="chatbot-close-button" aria-label="Close Chat">&times;</button>
        </div>
        <div id="chatbot-messages">
            <div class="chat-message bot">Hello! How can I help you find the right university or program today?</div>
            {% comment %} Messages will be added here dynamically {% endcomment %}
        </div>
        <div id="chatbot-input-area">
            <input type="text" id="chatbot-input" placeholder="Ask a question..." autocomplete="off">
            <button id="chatbot-send-button" disabled>Send</button>
        </div>
    </div>
    <button id="chatbot-toggle-button" aria-label="Toggle Chat">
        <i class="fas fa-comments"></i>
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const toggleButton = document.getElementById('chatbot-toggle-button');
    const chatWindow = document.getElementById('chatbot-window');
    const closeButton = document.getElementById('chatbot-close-button');
    const messagesContainer = document.getElementById('chatbot-messages');
    const inputField = document.getElementById('chatbot-input');
    const sendButton = document.getElementById('chatbot-send-button');

    // --- Toggle Chat Window ---
    toggleButton.addEventListener('click', () => {
        chatWindow.classList.toggle('active');
        if (chatWindow.classList.contains('active')) {
            inputField.focus();
        }
    });

    closeButton.addEventListener('click', () => {
        chatWindow.classList.remove('active');
    });

    // --- Enable/Disable Send Button ---
    inputField.addEventListener('input', () => {
        sendButton.disabled = inputField.value.trim() === '';
    });

    // --- Send Message ---
    const sendMessage = async () => {
        const messageText = inputField.value.trim();
        if (!messageText) return;

        // Display user message
        appendMessage(messageText, 'user');
        inputField.value = '';
        sendButton.disabled = true;

        // Show loading indicator - Pass classes separately
        const loadingElement = appendMessage('', ['bot', 'loading']); // Pass as an array or separate args
        if (loadingElement) { // Check if element was created
             loadingElement.innerHTML = '<span></span><span></span><span></span>'; // Add bouncing dots
        }

        try {
            // --- API Call ---
            // TODO: Replace with actual API endpoint URL
            const response = await fetch('/api/chatbot/', { // Placeholder URL
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Important for Django POST requests
                },
                body: JSON.stringify({ message: messageText })
            });

            // Always remove loading indicator after fetch attempt
            if (loadingElement && loadingElement.parentNode) {
                loadingElement.remove();
            }

            if (!response.ok) {
                 // Try to get error details from response body if possible
                let errorData = { error: `HTTP error! Status: ${response.status}` };
                try {
                    errorData = await response.json(); // Attempt to parse JSON error from backend
                    console.error('Chatbot API Error Response (non-OK):', errorData);
                } catch (e) {
                    console.error('Could not parse error response body:', e);
                }
                 // Display backend error or generic HTTP error
                const errorMsg = errorData.error || errorData.reply || `HTTP error! Status: ${response.status}`;
                appendMessage(errorMsg, 'bot');
                // No need to throw here, just let the function end after displaying the error
                return; // Stop further processing
            }

            // Process successful response
            const data = await response.json();
            console.log('Raw API Response (OK):', data); // Log the raw response

            if (data.reply) {
                // Remove asterisks from the reply before displaying
                const cleanedReply = data.reply.replace(/\*/g, ''); // Replace all asterisks with nothing
                appendMessage(cleanedReply, 'bot');
            } else {
                // Handle cases where response is OK but doesn't contain 'reply'
                const errorMsg = data.error || 'Received an unexpected response from the assistant.';
                appendMessage(errorMsg, 'bot');
                console.error('No reply in successful API response:', data);
            }

        } catch (error) { // Catch fetch errors (e.g., network error) or JSON parsing errors
             // Ensure loading indicator is removed on any catch
            if (loadingElement && loadingElement.parentNode) {
                loadingElement.remove();
            }
            // Log the specific error to the console for debugging
            console.error('Chatbot sendMessage Error (Fetch/Network/JSON Parse):', error);
            // Display a user-friendly message
            appendMessage('Sorry, I could not connect to the assistant at this moment. Please check your connection or try again later.', 'bot');
        }
    };

    sendButton.addEventListener('click', sendMessage);
    inputField.addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !sendButton.disabled) {
            sendMessage();
        }
    });

    // --- Append Message to UI ---
    // Modified to accept a string or an array for type/classes
    const appendMessage = (text, typeOrClasses) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message'); // Base class

        // Add specific type/classes
        if (Array.isArray(typeOrClasses)) {
            typeOrClasses.forEach(cls => messageElement.classList.add(cls));
        } else if (typeof typeOrClasses === 'string') {
            messageElement.classList.add(typeOrClasses);
        }

        // Basic sanitization (replace with a more robust library if needed)
        // Only set textContent if text is provided (prevents overwriting loading dots)
        if (text) {
            messageElement.textContent = text;
        }
        messagesContainer.appendChild(messageElement);
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        return messageElement; // Return the element for potential modification (like removing loading)
    };

    // --- Helper function to get CSRF token ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
